# Табличные данные {#sec-TidyData}

```{r setup-table-data}
#| echo: false
#| warning: false
#| message: false
library(tidyverse)
library(magrittr)
library(kableExtra)
```

Подготовка данных к анализу и их «чистка» может занимать б&oacute;льшую часть времени, поэтому очень важно ввести определенные требования к исходным данным.
Большинство данных, поступающих в информационных потоках для статистического анализа, представляют собой *таблицы*, имеющие *строки* и *столбцы*.
Непосредственно *массив табличных данных* представляет собой набор *значений*, каждое из которых принадлежит своей *переменной* и *наблюдению*.

Упорядоченность или хаотичность данных зависит от того, как строки, столбцы и формирующие их таблицы, сопоставляются с наблюдениями, переменными и их типами. Вот некоторые распространенные проблемы при подготовке данных к анализу:

* Отсутствующие имена заголовков, когда заголовки столбцов --- это значения, а не имена переменных. Слишком длинные имена заголовков. Переменные хранятся как в строках, так и в столбцах.

* Несколько переменных хранятся в одном столбце. Несколько значений хранится в одной ячейке, данные в одной ячейке не упорядочены. Одна единица наблюдения хранится в нескольких таблицах.

* Разнородные данные: в одной таблице хранится несколько типов единиц измерения. 

* Проблема пропущенных значений, отсутствие обозначений для них.

## Принцип «аккуратных данных»

Формулировке стандарта упорядоченных данных, проблемам организации и семантики данных, а также приведения данных к нормальной форме посвящена статья @JSSv059i10 Хадли Уикема, главного научного сотрудника [RStudio Inc.](https://rstudio.com/) (теперь [Posit](https://posit.co/)), в которой дано следующее определение «*аккуратных данных*» (или «*опрятных данных*»)[^tidy_data].

[^tidy_data]: от англ. *tidy data*

1. Каждая переменная образует столбец.

2. Каждое наблюдение образует строку.

3. Каждый тип единицы наблюдения формирует таблицу.

Любое нарушение хотя бы одного из данных правил считается неупорядоченными данными. Аккуратные данные позволяют аналитику или компьютеру легко извлекать необходимые переменные, поскольку они обеспечивают стандартный способ структурирования набора данных. Такого рода стандартизация также упрощает функции агрегации, что гарантирует исключение ошибок на каждом этапе преобразования.

Большинство неупорядоченных наборов данных можно привести в соответствие с помощью небольшого набора инструментов: приведения к сводным таблицам (длинным или широким) и разделения таблиц.

В качестве примера, создадим простейшую таблицу, показывающую количество ... в двух субъектах Байкальского региона[^RMD_view].

[^RMD_view]: Для отображения таблицы в **HTML**-формате можно использовать команду `kable(num)` библиотеки `knitr`.

```{.r}
num <- 
  tibble::tribble(~"Год", 
                  ~"Иркутская область", 
                  ~"Республика Бурятия",
                   2006, 1121, 1206,
                   2007, 1585, 1336,
                   2008, 1927, 1086,
                   2009, 1583, 1214,
                   2010,  901,  686)

num
```

```{r}
#| echo: false
num <- 
  tibble::tribble(~"Год", 
                  ~"Иркутская область", 
                  ~"Республика Бурятия",
                   2006, 1121, 1206,
                   2007, 1585, 1336,
                   2008, 1927, 1086,
                   2009, 1583, 1214,
                   2010,  901,  686)

num|>
  kbl() |>
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = T,
                position = "center")
```

Мы создали таблицу с 5-ю строками и 3-мя столбцами, указав их имена как `~"имя"` и перечислив значения. Полученная нами таблица не представляет собой аккуратные данные если мы примем, что имя региона является переменной. Поскольку мы поставили названия регионов в названия столбцов, следовательно <ins>каждая строка будет содержать более одного значения</ins>. 

Покажем, как можно сделать данные из примера «аккуратными». Дело в том, что одни и те же данные можно представлять в *широком* и в *длинном* формате.

* *Широкий формат данных* означает, что каждая строка в таблице данных содержит информацию о нескольких наблюдениях.

* *Длинный формат данных* означает, что каждая строка в таблице данных содержит информацию об одном наблюдении.

Широкий формат данных применяется для представления данных в виде *сводных таблиц*, например, для презентации. Для обработки данных и их последующей визуализации применяется длинный формат данных, именно этот формат данных используется в понятии «аккуратные данные»[^long-to-wide].

[^long-to-wide]: Автоматическое преобразование табличных данных из широкого формата в длинный и обратно будет рассмотрено далее.

После преобразования к длинному формату данных таблицы, рассмотренной в примере выше, данные становятся «аккуратными».

```{r}
#| echo: false
pivot_longer(num, -"Год", 
             names_to  = "Регион", 
             values_to = "Значения") |>
  kbl() |>
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = T,
                position = "center")
```

Теперь каждая строка соответствует одному наблюдению и содержит уникальную информацию `Год`, `Регион` и `Значение` --- количество ... (ед.).

